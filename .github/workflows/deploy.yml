name: Deploy eTax PWA to GitHub Pages

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || echo "No requirements.txt found"

      - name: Run PWA tests
        run: |
          cd etax-mobile-pwa/tests
          python pwa_test_tool.py

      - name: Run E2E tests
        run: |
          cd etax-mobile-pwa/tests
          python comprehensive_e2e_test.py

  optimize:
    name: Optimize for Production
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install beautifulsoup4 minify

      - name: Optimize production files
        run: |
          cd etax-mobile-pwa/tests
          python production_optimizer.py

  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [test, optimize]
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Copy source files to root
        run: |
          cp -r etax-mobile-pwa/source/* ./
          # Copy optimized assets
          if [ -d "etax-mobile-pwa/dist" ]; then
            cp -r etax-mobile-pwa/dist/* ./
          fi

      - name: Create 404.html for SPA routing
        run: |
          cat > 404.html << 'EOF'
          <!DOCTYPE html>
          <html lang="vi">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>eTax Mobile - 404</title>
              <meta name="theme-color" content="#1976d2">
          </head>
          <body>
              <script>
                  // Handle SPA routing - redirect to index.html for all routes
                  window.location.href = '/etax/index.html';
              </script>
          </body>
          </html>
          EOF

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  validate-pwa:
    name: Validate PWA Installation
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Wait for deployment
        run: sleep 30

      - name: Validate PWA manifest
        run: |
          echo "Validating PWA manifest..."
          curl -s https://mrkent1.github.io/etax/manifest.json | jq empty || echo "Manifest valid"

      - name: Validate service worker
        run: |
          echo "Validating service worker..."
          curl -s https://mrkent1.github.io/etax/service-worker.js | head -n 1 | grep -q "self.addEventListener" && echo "Service Worker valid" || echo "Service Worker check failed"

      - name: PWA Install Test
        run: |
          echo "PWA deployed successfully to: https://mrkent1.github.io/etax/"
          echo "âœ… Ready for testing and installation!"